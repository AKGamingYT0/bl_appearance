var re=Object.create;var T=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var R=e=>t=>{var n=e[t];if(n)return n();throw new Error("Module not found in bundle: "+t)};var m=(e,t)=>()=>(e&&(t=e(e=0)),t);var ce=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),x=(e,t)=>{for(var n in t)T(e,n,{get:t[n],enumerable:!0})},pe=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of oe(t))!ie.call(e,a)&&a!==n&&T(e,a,{get:()=>t[a],enumerable:!(r=ae(t,a))||r.enumerable});return e};var S=(e,t,n)=>(n=e!=null?re(se(e)):{},pe(t||!e||!e.__esModule?T(n,"default",{value:e,enumerable:!0}):n,e));function p(e,t,...n){let r;do r=`${e}:${Math.floor(Math.random()*100001)}:${t}`;while(h[r]);return emitNet(`_bl_cb_${e}`,t,N,r,...n),new Promise(a=>{h[r]=a})}function o(e,t){onNet(`_bl_cb_${e}`,async(n,r,...a)=>{let i=source,g;try{g=await t(i,...a)}catch(_){console.error(`an error occurred while handling callback event ${e}`),console.log(`^3${_.stack}^0`)}emitNet(`_bl_cb_${n}`,i,r,g)})}var N,h,le,y,k,c,ue,P,d=m(()=>{N=GetCurrentResourceName(),h={};onNet(`_bl_cb_${N}`,(e,...t)=>{let n=h[e];return n&&n(...t)});le=exports.bl_bridge,y=le.core(),k=e=>y.GetPlayer(e),c=e=>{let t=y.GetPlayer(e);return t?t.id:null},ue=exports.bl_appearance.config(),P=ue});var E=ce(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.oxmysql=void 0;var j=[];function b(e,t){if(!e)throw new TypeError(t)}var l=(e,t,n,r)=>{if(typeof e=="number"&&(e=j[e]),r?b(typeof e=="object",`First argument expected object, recieved ${typeof e}`):b(typeof e=="string",`First argument expected string, received ${typeof e}`),t){let a=typeof t;b(a==="object"||a==="function",`Second argument expected object or function, received ${a}`),!n&&a==="function"&&(n=t,t=void 0)}return n!==void 0&&b(typeof n=="function",`Third argument expected function, received ${typeof n}`),[e,t,n]},A=global.exports.oxmysql,fe=GetCurrentResourceName();function u(e,t,n){return new Promise((r,a)=>{A[e](t,n,(i,g)=>{if(g)return a(g);r(i)},fe,!0)})}O.oxmysql={store(e){return b(typeof e!="string",`Query expects a string, received ${typeof e}`),j.push(e)},ready(e){setImmediate(async()=>{for(;GetResourceState("oxmysql")!=="started";)await new Promise(t=>setTimeout(t,50));e()})},async query(e,t,n){[e,t,n]=l(e,t,n);let r=await u("query",e,t);return n?n(r):r},async single(e,t,n){[e,t,n]=l(e,t,n);let r=await u("single",e,t);return n?n(r):r},async scalar(e,t,n){[e,t,n]=l(e,t,n);let r=await u("scalar",e,t);return n?n(r):r},async update(e,t,n){[e,t,n]=l(e,t,n);let r=await u("update",e,t);return n?n(r):r},async insert(e,t,n){[e,t,n]=l(e,t,n);let r=await u("insert",e,t);return n?n(r):r},async prepare(e,t,n){[e,t,n]=l(e,t,n);let r=await u("prepare",e,t);return n?n(r):r},async rawExecute(e,t,n){[e,t,n]=l(e,t,n);let r=await u("rawExecute",e,t);return n?n(r):r},async transaction(e,t,n){[e,t,n]=l(e,t,n,!0);let r=await u("transaction",e,t);return n?n(r):r},isReady(){return A.isReady()},async awaitConnection(){return await A.awaitConnection()}}});var me={};var I=m(()=>{});var D={};x(D,{default:()=>de});var L,ge,ye,de,J=m(()=>{L=S(E(),1);d();v();ge=e=>new Promise(t=>setTimeout(t,e)),ye=async e=>{let t=await L.oxmysql.query("SELECT * FROM `players`");if(t){for(let n of t)if(n.skin){await p("bl_appearance:client:migration:setAppearance",e,{type:"fivem",data:JSON.parse(n.skin)}),await ge(100);let r=await p("bl_appearance:client:getAppearance",e),a=parseInt(e);await f(a,n.citizenid,r)}console.log("Converted "+t.length+" appearances")}},de=ye});var F={};x(F,{default:()=>Se});var M,be,Ee,Se,$=m(()=>{M=S(E(),1);d();v();be=e=>new Promise(t=>setTimeout(t,e)),Ee=async e=>{let t=await M.oxmysql.query("SELECT * FROM `playerskins` WHERE active = 1");if(t){for(let n of t)if(n.skin){await p("bl_appearance:client:migration:setAppearance",e,{type:"illenium",data:JSON.parse(n.skin)}),await be(100);let r=await p("bl_appearance:client:getAppearance",e),a=parseInt(e);await f(a,n.citizenid,r)}console.log("Converted "+t.length+" appearances")}},Se=Ee});var W={};x(W,{default:()=>we});var H,Oe,ve,we,U=m(()=>{H=S(E(),1);d();v();Oe=e=>new Promise(t=>setTimeout(t,e)),ve=async e=>{let t=await H.oxmysql.query("SELECT * FROM `playerskins` WHERE active = 1");if(t){for(let n of t){emitNet("qb-clothes:loadSkin",e,0,n.model,n.skin),await Oe(200);let r=await p("bl_appearance:client:getAppearance",e),a=parseInt(e);await f(a,n.citizenid,r)}console.log("Converted "+t.length+" appearances")}},we=ve});var _e,C=m(()=>{_e=R({"./migrate/esx.ts":()=>Promise.resolve().then(()=>(I(),me)),"./migrate/fivem.ts":()=>Promise.resolve().then(()=>(J(),D)),"./migrate/illenium.ts":()=>Promise.resolve().then(()=>($(),F)),"./migrate/qb.ts":()=>Promise.resolve().then(()=>(U(),W))})});async function G(e,t){let n=y.GetPlayer(e).job||{name:"unknown",grade:{name:"unknown"}},r=await s.oxmysql.prepare("SELECT * FROM outfits WHERE player_id = ? OR (jobname = ? AND jobrank <= ?)",[t,n.name,n.grade.name]);return r?(Array.isArray(r)||(r=[r]),r.map(i=>({id:i.id,label:i.label,outfit:JSON.parse(i.outfit),jobname:i.jobname}))):[]}async function B(e,t){let n=c(e);return await s.oxmysql.update("UPDATE outfits SET label = ? WHERE player_id = ? AND id = ?",[t.label,n,t.id])}async function V(e,t){let n=c(e);return await s.oxmysql.update("DELETE FROM outfits WHERE player_id = ? AND id = ?",[n,t])>0}async function z(e,t){let n=c(e),r=null,a=0;return t.job&&(r=t.job.name,a=t.job.rank),await s.oxmysql.insert("INSERT INTO outfits (player_id, label, outfit, jobname, jobrank) VALUES (?, ?, ?, ?, ?)",[n,t.label,JSON.stringify(t.outfit),r,a])}async function Q(e,t){let n=await s.oxmysql.prepare("SELECT outfit FROM outfits WHERE id = ?",[t]);return JSON.parse(n)}async function Y(e,t,n,r){let a=await s.oxmysql.query("SELECT label, outfit FROM outfits WHERE id = ?",[n]);return!a||typeof a!="object"||Object.keys(a).length===0?{success:!1,message:"Outfit not found"}:{success:!0,newId:await s.oxmysql.insert("INSERT INTO outfits (player_id, label, outfit) VALUES (?, ?, ?)",[t,r,a.outfit])}}async function K(e,t){let n=c(e);return await s.oxmysql.update("UPDATE appearance SET skin = ? WHERE id = ?",[JSON.stringify(t),n])}async function X(e,t){let n=c(e);return await s.oxmysql.update("UPDATE appearance SET clothes = ? WHERE id = ?",[JSON.stringify(t),n])}async function Z(e,t){let n=c(e);return await s.oxmysql.update("UPDATE appearance SET tattoos = ? WHERE id = ?",[JSON.stringify(t),n])}async function q(e,t){t||(t=c(e));let n=await s.oxmysql.prepare("SELECT skin FROM appearance WHERE id = ?",[t]);return JSON.parse(n)}async function ee(e,t){t||(t=c(e));let n=await s.oxmysql.prepare("SELECT clothes FROM appearance WHERE id = ?",[t]);return JSON.parse(n)}async function te(e,t){t||(t=c(e));let n=await s.oxmysql.prepare("SELECT tattoos FROM appearance WHERE id = ?",[t]);return JSON.parse(n)||[]}async function ne(e,t){if(!t&&!e)return null;t||(t=c(e));let n=await s.oxmysql.single("SELECT * FROM appearance WHERE id = ? LIMIT 1",[t]);if(!n)return null;let r={...JSON.parse(n.skin),...JSON.parse(n.clothes),tattoos:JSON.parse(n.tattoos)};return r.id=n.id,r}var s,f,w,v=m(()=>{d();s=S(E(),1);C();o("bl_appearance:server:getOutfits",G);exports("GetOutfits",G);o("bl_appearance:server:renameOutfit",B);exports("RenameOutfit",B);o("bl_appearance:server:deleteOutfit",V);exports("DeleteOutfit",V);o("bl_appearance:server:saveOutfit",z);exports("SaveOutfit",z);o("bl_appearance:server:fetchOutfit",Q);exports("FetchOutfit",Q);o("bl_appearance:server:importOutfit",Y);exports("ImportOutfit",Y);o("bl_appearance:server:saveSkin",K);exports("SaveSkin",K);o("bl_appearance:server:saveClothes",X);exports("SaveClothes",X);o("bl_appearance:server:saveTattoos",Z);exports("SaveTattoos",Z);o("bl_appearance:server:getSkin",q);exports("GetSkin",function(e){return q(null,e)});f=async(e,t,n)=>{if(e&&t){let _=c(e);if(t!==_){console.warn("You are trying to save an appearance for a different player",e,t);return}}t||(t=c(e));let r={drawables:n.drawables,props:n.props,headOverlay:n.headOverlay},a={headBlend:n.headBlend,headStructure:n.headStructure,hairColor:n.hairColor,model:n.model},i=n.tattoos||[];return await s.oxmysql.prepare("INSERT INTO appearance (id, clothes, skin, tattoos) VALUES (?, ?, ?, ?) ON DUPLICATE KEY UPDATE clothes = VALUES(clothes), skin = VALUES(skin), tattoos = VALUES(tattoos);",[t,JSON.stringify(r),JSON.stringify(a),JSON.stringify(i)])};o("bl_appearance:server:saveAppearance",f);exports("SaveAppearance",function(e,t){return f(null,e,t)});o("bl_appearance:server:getClothes",ee);exports("GetClothes",function(e){return ee(null,e)});o("bl_appearance:server:getTattoos",te);exports("GetTattoos",function(e){return te(null,e)});o("bl_appearance:server:getAppearance",ne);exports("GetAppearance",function(e){return ne(null,e)});onNet("bl_appearance:server:setroutingbucket",()=>{SetPlayerRoutingBucket(source.toString(),source)});onNet("bl_appearance:server:resetroutingbucket",()=>{SetPlayerRoutingBucket(source.toString(),0)});RegisterCommand("migrate",async e=>{e=e!==0?e:parseInt(getPlayers()[0]);let n=exports.bl_appearance.config();(await _e(`./migrate/${n.previousClothing==="fivem-appearance"?"fivem":n.previousClothing}.ts`)).default(e)},!1);w=P.outfitItem;w||console.warn("bl_appearance: No outfit item configured, please set it in config.lua");o("bl_appearance:server:itemOutfit",async(e,t)=>{y.GetPlayer(e).addItem(w,1,t)});y.RegisterUsableItem(w,async(e,t,n)=>{k(e)?.removeItem(w,1,t)&&emitNet("bl_appearance:server:useOutfitItem",e,n.outfit)})});v();export{f as saveAppearance};
